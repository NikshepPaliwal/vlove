<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Valentine ğŸ’˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fff0f3 0%, #ffe6eb 100%); text-align: center; padding: 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
        .container { width: 100%; max-width: 400px; background: rgba(255,255,255,0.9); padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 71, 87, 0.2); backdrop-filter: blur(10px); }
        h1 { color: #ff4757; margin-bottom: 10px; }
        p { color: #555; font-size: 0.9rem; }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 2px solid #ffccd5; box-sizing: border-box; font-family: inherit; }
        input:focus { outline: none; border-color: #ff4757; }
        
        button { width: 100%; background: #ff4757; color: white; border: none; padding: 15px; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: transform 0.2s; }
        button:active { transform: scale(0.95); }
        button.secondary { background: #ffe0e3; color: #ff4757; }
        
        .hidden { display: none; }
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #ff4757; }
        .timestamp { font-size: 0.7rem; color: #999; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="scene-creator">
            <h1>Valentine Link ğŸ’Œ</h1>
            <p>Create a link, send it to your crush, and see their reply here.</p>
            <button onclick="generateLink()">Create My Link</button>
            <br>
            <div id="link-area" class="hidden" style="margin-top:20px;">
                <input type="text" id="my-link" readonly onclick="this.select()">
                <button onclick="copyLink()">Copy Link ğŸ“‹</button>
                <button class="secondary" onclick="checkResponses()">Check Responses ğŸ“¬</button>
            </div>
        </div>

        <div id="scene-receiver" class="hidden">
            <h1>Will you be my Valentine? ğŸ¥º</h1>
            <div style="font-size:60px; margin: 20px 0;">ğŸŒ¹</div>
            <input type="text" id="r-name" placeholder="Your Name">
            <textarea id="r-msg" rows="3" placeholder="Type a message... (Optional)"></textarea>
            
            <button onclick="sendReply('YES')">YES! ğŸ’–</button>
            <button class="secondary" onclick="sendReply('NO')">No ğŸ˜¢</button>
        </div>

        <div id="scene-dashboard" class="hidden">
            <h1>Inbox ğŸ’Œ</h1>
            <div id="responses-list">Loading...</div>
            <button class="secondary" onclick="location.reload()">Back</button>
        </div>

    </div>

    <script>
        // ğŸ‘‡ğŸ‘‡ PASTE YOUR GOOGLE SCRIPT URL BELOW ğŸ‘‡ğŸ‘‡
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCVWi-VitF2yjjGstKeFfeTu9aF2XZE6IS9TkkhQzh_PpNsEth30P4kObnFotqOV-p/exec"; 

        // --- Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const urlID = urlParams.get('id'); // ID from the URL (if receiving)

        // On Load: Decide which scene to show
        if (urlID) {
            // If there is an ID in the URL, someone is receiving the card
            showScene('scene-receiver');
        } else {
            // No ID? You are the Creator
            showScene('scene-creator');
            
            // If you already made a link before, show it
            const savedID = localStorage.getItem('v_uid');
            if(savedID) {
                document.getElementById('link-area').classList.remove('hidden');
                document.getElementById('my-link').value = window.location.href + "?id=" + savedID;
            }
        }

        function showScene(id) {
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- CREATOR FUNCTIONS ---
        function generateLink() {
            let uid = localStorage.getItem('v_uid');
            if(!uid) {
                // Generate random ID (e.g., user_x8d9s)
                uid = 'user_' + Math.random().toString(36).substr(2, 6);
                localStorage.setItem('v_uid', uid);
            }
            
            const link = window.location.href.split('?')[0] + "?id=" + uid;
            document.getElementById('my-link').value = link;
            document.getElementById('link-area').classList.remove('hidden');
        }

        function copyLink() {
            const copyText = document.getElementById("my-link");
            copyText.select();
            document.execCommand("copy");
            alert("Link copied! Send it to them.");
        }

        // --- RECEIVER FUNCTIONS ---
        function sendReply(status) {
            const name = document.getElementById('r-name').value;
            const msg = document.getElementById('r-msg').value;

            if(!name) { alert("Please enter your name!"); return; }

            if(status === 'YES') confetti();

            // Send to Google Sheet
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Important for Google Scripts
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: "save",
                    uid: urlID,
                    name: name,
                    msg: msg,
                    status: status
                })
            }).then(() => {
                document.querySelector('.container').innerHTML = "<h1>Sent! â¤ï¸</h1><p>Thanks for your answer.</p>";
            }).catch(err => alert("Error sending: " + err));
        }

        // --- DASHBOARD FUNCTIONS ---
        function checkResponses() {
            const uid = localStorage.getItem('v_uid');
            if(!uid) return;

            showScene('scene-dashboard');
            const list = document.getElementById('responses-list');
            list.innerHTML = "Checking...";

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "read", uid: uid })
            })
            .then(res => res.json())
            .then(response => {
                list.innerHTML = "";
                if(response.data.length === 0) {
                    list.innerHTML = "<p>No replies yet. Keep waiting! ğŸ•’</p>";
                    return;
                }
                
                // Show latest first
                response.data.reverse().forEach(row => {
                    const html = `
                    <div class="card">
                        <strong>${row.name}</strong> said <b style="color:${row.status=='YES'?'#2ed573':'#ff4757'}">${row.status}</b>
                        <br>${row.msg}
                        <span class="timestamp">${new Date(row.date).toLocaleString()}</span>
                    </div>`;
                    list.innerHTML += html;
                });
            });
        }
    </script>
</body>
</html>
